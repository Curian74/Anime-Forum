@using System.Security.Claims
@using WibuBlog.ViewModels.Post
@using WibuBlog.Helpers
@using Application.Common.MessageOperations
@model PostDetailVM

<link rel="stylesheet" href="~/fontawesome/css/all.css" />
<link rel="stylesheet" href="~/css/postDetail.css" />
<link rel="stylesheet" href="~/richtexteditor/rte_theme_default.css" />
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.17.2/dist/sweetalert2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.17.2/dist/sweetalert2.all.min.js"></script>

<section>
    <div class="container mt-4">
        <div class="post-container">
            <div class="mb-3">
                <a asp-action="NewPosts" class="btn btn-secondary">
                    <i class="fa-solid fa-arrow-left"></i> Post List
                </a>
            </div>


            <div class="post-header d-flex justify-content-between">
                <div class="d-flex gap-2">
                    <img src="@Model.User?.ProfilePhoto?.Url" alt="Avatar" class="avatar">
                    <div>
                        <h5 class="m-0">@Model.Post?.User?.UserName</h5>
                        <small class="text-muted">@DateFormatHelper.GetDateFormat(Model.Post.CreatedAt)</small>
                    </div>
                </div>
                @if (User.Identity.IsAuthenticated)
                {
                    <div class="dropdown">
                        <button class="btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa-solid fa-ellipsis fs-5"></i>
                        </button>
                        <ul style="background-color:#eaebec" class="dropdown-menu">
                            @{
                                if (Model.User?.Id == Model.Post.UserId)
                                {
                                    <li>
                                        <a asp-route-id="@Model.Post.Id"
                                           class="dropdown-item" asp-action="Edit" asp-controller="Post">
                                            Edit
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider border-top border-secondary"></li>
                                    <li>
                                        <a class="dropdown-item text-danger"
                                           onclick="confirmDeletePost('@Model.Post.Id')"
                                           style="color: red !important;">
                                            Delete
                                        </a>
                                    </li>
                                }

                                else
                                {
                                    <li><a class="dropdown-item text-warning" href="#">Report</a></li>
                                }
                            }
                        </ul>
                    </div>
                }
            </div>
            <div class="post-content mt-2">
                <h3 class="mb-3">@Model.Post?.Title</h3>
                <p id="post-content">@Html.Raw(Model.Post?.Content)</p>
            </div>

            <!-- Post Actions -->
            <div class="post-actions mt-5">
                <div class="action-button d-flex align-items-center justify-content-between px-3 py-2">
                    <div class="d-flex align-items-center">
                        <a href="#" class="vote-btn me-1" data-vote="up"><i class="fa-regular fa-circle-up"></i></a>
                        <span>@Model.Post?.Votes.Where(x => x.IsUpvote).Count()</span>
                    </div>
                    <a href="#" class="vote-btn" data-vote="down"><i class="fa-regular fa-circle-down"></i></a>
                </div>
                <div class="action-button d-flex align-items-center justify-content-center px-3">
                    <a href="#"><i class="fa-regular fa-comment"></i> @Model.Post?.Comments.Where(c => c.IsHidden == false).Count()</a>
                </div>
            </div>

            <!-- Comment Input -->
            @{
                if (Model.User != null)
                {
                    <div class="mt-3">
                        <button class="btn btn-success" id="toggle-btn">Add your comment</button>
                    </div>
                    <div id="comment-field" class="w-100">
                        <form asp-controller="Comment" asp-action="PostComment" class="mt-3">
                            <div asp-validation-summary="All"></div>
                            <input type="hidden" name="postId" id="post-id" value="@Model.Post?.Id" />
                            <input type="hidden" name="userId" id="user-id" value="@Model.User?.Id" />
                            <textarea id="content" name="content" class="form-control" rows="3" placeholder="Add a comment"></textarea>
                            <div class="d-flex justify-content-end mt-2">
                                <button type="button" id="cancel-btn" class="btn btn-secondary me-2">Cancel</button>
                                <button id="submit-btn" class="btn btn-primary">Post Comment</button>
                            </div>
                        </form>
                    </div>
                }

                else
                {
                    <p class="mt-3 fst-italic text-danger">*@MessageConstants.ME029*</p>
                }
            }

            <!-- Comment Section -->
            @{
                if (Model.Comments != null && Model.Comments.Items.Any())
                {
                    <div class="comment-section">
                        <h5 class="px-0">Comments (@Model.Post?.Comments.Where(c => c.IsHidden == false).Count())</h5>
                        @*Pagination*@
                        <div class="d-flex justify-content-between">
                            <div>
                                <button class="sort-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <small>Sort By <i class="fa-solid fa-angle-down"></i></small>
                                </button>
                                <ul class="dropdown-menu">
                                    <li class="mb-3 mx-3">
                                        <p class="w-100 fw-bold" style="font-size:80%;">Sort By</p>
                                    </li>
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2" href="#">
                                            <i class="fa-regular fa-sun fs-5"></i>
                                            Latest
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2" href="#">
                                            <i class="fa-solid fa-box-archive fs-5"></i>
                                            Oldest
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div>
                                @{
                                    int currentPage = Model.Comments.PageNumber;
                                    int totalPages = Model.Comments.TotalPages;
                                    int maxPagesToShow = 3;//Max pages hien tri trai phai
                                }

                                <nav aria-label="Page navigation">
                                    <ul class="pagination">
                                        @if (Model.Comments.HasPreviousPage)
                                        {
                                            <li class="page-item">
                                                <a class="page-link" asp-action="Detail" asp-route-page="@(currentPage - 1)"
                                                   asp-route-pageSize="@Model.Comments.PageSize" aria-label="Previous">
                                                    <span aria-hidden="true">&laquo;</span>
                                                </a>
                                            </li>
                                        }

                                        @if (totalPages <= 5) //Page <= 5 thi display all
                                        {
                                            @for (int i = 1; i <= totalPages; i++)
                                            {
                                                <li class="page-item @(i == currentPage ? "active" : "")">
                                                    <a class="page-link" asp-action="Detail" asp-route-page="@i"
                                                       asp-route-pageSize="@Model.Comments.PageSize">@i</a>
                                                </li>
                                            }
                                        }
                                        else
                                        {
                                            if (currentPage > maxPagesToShow + 1)
                                            {
                                                <li class="page-item">
                                                    <a class="page-link" asp-action="Detail" asp-route-page="1"
                                                       asp-route-pageSize="@Model.Comments.PageSize">1</a>
                                                </li>
                                                <li class="page-item disabled"><span class="page-link">...</span></li>
                                            }

                                            int startPage = Math.Max(1, currentPage - maxPagesToShow / 2);
                                            int endPage = Math.Min(totalPages, startPage + maxPagesToShow - 1);

                                            if (endPage == totalPages)
                                            {
                                                startPage = Math.Max(1, totalPages - maxPagesToShow + 1);
                                            }

                                            for (int i = startPage; i <= endPage; i++)
                                            {
                                                <li class="page-item @(i == currentPage ? "active" : "")">
                                                    <a class="page-link" asp-action="Detail" asp-route-page="@i"
                                                       asp-route-pageSize="@Model.Comments.PageSize">@i</a>
                                                </li>
                                            }

                                            if (currentPage < totalPages - maxPagesToShow)
                                            {
                                                <li class="page-item disabled"><span class="page-link">...</span></li>
                                                <li class="page-item">
                                                    <a class="page-link" asp-action="Detail" asp-route-page="@totalPages"
                                                       asp-route-pageSize="@Model.Comments.PageSize">@totalPages</a>
                                                </li>
                                            }
                                        }

                                        @if (Model.Comments.HasNextPage)
                                        {
                                            <li class="page-item">
                                                <a class="page-link" asp-action="Detail" asp-route-page="@(currentPage + 1)"
                                                   asp-route-pageSize="@Model.Comments.PageSize" aria-label="Next">
                                                    <span aria-hidden="true">&raquo;</span>
                                                </a>
                                            </li>
                                        }
                                    </ul>
                                </nav>

                            </div>
                        </div>
                        @{
                            foreach (var c in Model.Comments.Items.Where(c => c.IsHidden == false))
                            {
                                <div class="card p-2 mb-2">
                                    <div class="d-flex align-items-start">
                                        <img class="rounded-circle avatar me-2"
                                             src="@(c.User?.ProfilePhoto?.Url != null ? c.User.ProfilePhoto.Url : Url.Content("~/images/defaults/user/default_avatar.jpg"))" />
                                        <div>
                                            <div>
                                                <strong>@c.User?.UserName</strong> <br />
                                                <small class="fst-italic" style="font-size: 12px; color:#576f76;">
                                                    @DateFormatHelper.GetDateFormat(c.CreatedAt)
                                                </small>
                                                <p class="mb-1">@Html.Raw(c.Content)</p>
                                                @*<a href="#" class="btn-reply"><i class="fa-regular fa-comment"></i> Reply</a> *@
                                            </div>
                                            @*<div class="replies">
                                                <div class="card p-1 mb-1 mt-1">
                                                    <div class="d-flex align-items-start p-1">
                                                        <img src="https:data.voz.vn/avatars/l/1857/1857672.jpg?1674878168" alt="Avatar" class="avatar me-2">
                                                        <div class="h-25">
                                                            <strong>Reply 1</strong>
                                                            <p class="mb-0">This is a reply to the comment.This is a reply to the comment.This is a reply to the comment.This is a reply to the comment.This is a reply to the comment.This is a reply to the comment.This is a reply to the comment.</p>
                                                            <a href="#" class="btn-reply"><i class="fa-regular fa-comment"></i> Reply</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>*@
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }

                else
                {
                    <div class="d-flex align-items-center mt-5 gap-5">
                        <img style="width:4%" src="https://www.redditstatic.com/shreddit/assets/thinking-snoo.png" />
                        <div style="font-size: 14px;">
                            <h5 style="font-weight: 500">Be the first to comment</h5>
                            <div>
                                <p class="mb-0">Nobody's responded to this post yet.</p>
                                <p class="mb-0">Add your thoughts and get the conversation going.</p>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</section>
@section Scripts {
    <script src="~/js/postDetail.js"></script>
    <partial name="_ValidationScriptsPartial"></partial>
    <partial name="_RichTextEditorInit"></partial>
    <script type="text/javascript">
        var editor = new RichTextEditor("#content", configs);
    </script>
}
